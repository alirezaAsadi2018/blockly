<!DOCTYPE html>
<meta charset="UTF-8">

<!-- HTML file to host Blockly in a mobile WebView. -->
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <style type="text/css">
    html, body, #blocklyDiv {
      border: 0;
      height: 100%;
      margin: 0;
      padding: 0;
      width: 100%;
    }
  </style>
  <!-- Source Paho MQTT Client-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
  <!-- Utility Javascript -->
  <script src="mqtt.js"></script>
  <script src="blockly_compressed.js"></script>
  <script src="blocks_compressed.js"></script>
  <script src="javascript_compressed.js"></script>
  <script src="python_compressed.js"></script>
  <script src="toolbox_standard.js"></script>
  <!-- Select msg file -->
  <script id="lang_scripts" src="msg/js/fa.js"></script>
</head>
<body>
<p>
   <button onclick="showPython()">Show Python</button>
   <button onclick="showJs()">Show JavaScript</button>
   <button onclick="runJsCode()">Run JavaScript</button>
   <button onclick="changeLanguage()">change language!</button>
</p>
<div id="blocklyDiv" style="height: 550px;" ></div>

<script type="text/javascript">

	var myWorkspaceLang = 'fa';
	var myWorkspace;
	loadWorkspace();
	
    function showPython() {
      // Generate JavaScript code and display it.
      Blockly.Python.INFINITE_LOOP_TRAP = null;
      var code = Blockly.Python.workspaceToCode(myWorkspace);
      alert(code);
    }

    function showJs() {
      // Generate JavaScript code and display it.
      Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
      var code = Blockly.JavaScript.workspaceToCode(myWorkspace);
      alert(code);
    }

    function rotate(msg){
      mqttSend(msg);
    }
    
    function runJsCode() {
      // Generate JavaScript code and run it.
      window.LoopTrap = 1000;
      Blockly.JavaScript.INFINITE_LOOP_TRAP =
          'if (--window.LoopTrap == 0) throw "Infinite loop.";\n';
      var code = Blockly.JavaScript.workspaceToCode(myWorkspace);
      //debugger
      Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
	  
      try {
        eval(code);
      } catch (e) {
        alert(e);
      }
    }
	
	function callTts(text){
      Android.tts(text);
    }

    function callStt(){
      var string = "";
      try{
        string = Android.stt();
      }catch(e){
        alert(e);
      }
      return string;
    }
	
	function changeLanguage(){
		if(myWorkspaceLang === 'fa'){
			myWorkspaceLang = 'en';
		}else{
			myWorkspaceLang = 'fa';
		}
		
		// remove last loaded script
		document.getElementById('lang_scripts').remove();
		// load the new language script node
		var script = document.createElement('script');
		script.setAttribute("id", "lang_scripts");
		script.onload = function (e) {
			//do stuff with the script
			myWorkspace.dispose();
			loadWorkspace();	
		};
		script.src = 'msg/js/' + myWorkspaceLang + '.js';
		document.head.appendChild(script);	
	}

    function callAndroidStt(btn) {
      string = "default string";
      string = Android.stt();
      alert(string);
    }
	
	function loadWorkspace(){
		// when language is switched between fa(persian) and en(english), another toolbox with different category names is loaded,
		// rtl is also turned on when language is fa and off when it is en, the rest is the same.
		myWorkspace = Blockly.inject('blocklyDiv', {
			toolbox: BLOCKLY_TOOLBOX_XML['standard_' + myWorkspaceLang],
			collapse : true, 
			comments : true, 
			disable : true, 
			maxBlocks : Infinity, 
			trashcan : true, 
			horizontalLayout : false, 
			toolboxPosition : 'start', 
			css : true, 
			rtl : true, 
			scrollbars : true, 
			sounds : true, 
			oneBasedIndex : true, 
			grid : {
			spacing : 20, 
			length : 1, 
			colour : '#888', 
			snap : false
			}, 
			media: 'media/',
			// media : 'https://blockly-demo.appspot.com/static/media/', 
			rtl: (myWorkspaceLang === 'fa'),
			zoom : {
			controls : true, 
			wheel : true, 
			startScale : 1, 
			maxScale : 3, 
			minScale : 0.3, 
			scaleSpeed : 1.2
			}
		});
		myWorkspace.registerButtonCallback("myButtonPressed", callAndroidStt);
	}
</script>
</body>
</html>