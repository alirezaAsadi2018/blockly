<!DOCTYPE html>
<!-- HTML file to host Blockly in a mobile WebView. -->
<html dir="rtl" lang="fa">
<!-- <html lang="@locale@" data-manifest="" data-framework="typescript"> -->
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<!-- <meta name="viewport" content="width=device-width,height=device-height,user-scalable=no,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0"> -->
    <!-- <style type="text/css">
		html, body, #blocklyDiv {
		border: 0;
		height: 100%;
		margin: 0;
		padding: 0;
		width: 100%;
		}
	  </style> -->
	<style type="text/css">
		#blockly\:0 {
			width: 114px;
			/* margin-right: 15px; */
		}
		.zelos-renderer .blocklyText {
			fill: #fff;
		}
		.blocklySvg {
			background-color: rgb(236,240,241);
		}
		.blocklyTreeRoot {
			/* padding: 15px 0; */
			padding-top: 14px;
			width: 114px !important;
		}
		.blocklyTreeRow {
			margin-bottom: 14px;
		}
		.blocklyToolboxDiv {
			width: 114px;
			background-color: #FFFFFF;
			color: #575E75;
			/* padding-right: 15px !important; */
			/* font-family: sans-serif; */
		}
		.blocklyFlyoutBackground {
			fill: #4b4949;
			fill-opacity: 1;
		}
	</style>
  <!-- You MUST include jQuery before Fomantic -->
	<script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
  <!-- <script src="media/jquery.min.js"></script> -->
  <link rel="stylesheet" type="text/css" href="media/semantic.rtl.min.css">
  <script src="media/semantic.min.js"></script>
  <!-- Source Paho MQTT Client-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
  <!-- <script src="media/mqttws31.js" type="text/javascript"></script> -->
  <!-- Utility Javascript -->
  <script src="mqtt.js"></script>
  <script src="common-functions.js"></script>
  <script src="blockly_compressed.js"></script>
  <script src="blocks_compressed.js"></script>
  <script src="javascript_compressed.js"></script>
  <script src="python_compressed.js"></script>
  <script src="toolbox_standard.js"></script>
  <!-- Select msg file -->
  <script src="msg/js/fa.js"></script>
</head>
<body>
	<div>
		<div class="ui orange borderless top secondary inverted menu">
			<div class="item">
				<button class="ui button" onclick="showCode()">نمایش کد</button>
			</div>
			<div class="item">
				<button id="runButton" class="ui button" onclick="runCode()">اجرای کد</button>
			</div>
			<div class="item">
				<button class="ui button" onclick="stopCode()">توقف اجرا</button>
			</div>
			<div class="item">
				<div class="ui floating labeled icon dropdown button">
					<i class="dropdown icon"></i>
					<div class="default text">انتخاب زبان</div>
					<div class="menu">
					  <div class="item" onclick="setCodingLang('js')">
						<i class="js icon"></i>
						جاوااسکریپت
					  </div>
					  <div class="item" onclick="setCodingLang('py')">
						<i class="python icon"></i>
						پایتون
					  </div>
					</div>
				</div>
			</div>
			<div class="right menu">
				<div class="item">
					<div class="ui language floating dropdown link">
						<i class="world icon"></i>
						<span class="text">فارسی</span>
						<div class="menu">
						<div class="item" onclick="changeWorkspaceLang('fa')">فارسی</div>
						<div class="item" onclick="changeWorkspaceLang('en')">انگلیسی</div>
						</div>
					</div>
				</div>
				<div class="item">
					<div class="ui logo shape">
						<div class="sides">
							<div class="active ui side">
								<img class="ui tiny  image" src="media/roobin5.png">
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div id="blocklyDiv" style="height: 550px;" ></div>
	
<script type="text/js-worker">
	var hasMore =false;
	var ttsBusy = false;
	function isTtsBusy(){
		return ttsBusy;
	}
	function initApi(interpreter, globalObject) {
		// Add an API function for the alert() block.
		var wrapper = function(text) {
			postMessage('alert("' + (arguments.length ? text : '') + '")');
		};
		interpreter.setProperty(globalObject, 'alert',
			interpreter.createNativeFunction(wrapper));
		
		// Add an API function for the prompt() block.
		wrapper = function(text) {
			postMessage('prompt("' + text + '")');
		};
		interpreter.setProperty(globalObject, 'prompt',
			interpreter.createNativeFunction(wrapper));
		
		// Add an API function for the callStt() block.
		wrapper = function() {
			if(!navigator.userAgent.match(/Android/i)){
				console.log('stt started');
				var url = 'http://localhost:1234/set_stt_var';
				fetch(url)
				.then(data=>{console.log(data.url);})
				.catch(error=>console.log(error));
			}else{
				postMessage('callStt()');
			}
		};
		interpreter.setProperty(globalObject, 'callStt',
			interpreter.createNativeFunction(wrapper));

		// Add an API function for the callTts() block.
		wrapper = function(text) {
			if(!navigator.userAgent.match(/Android/i)){
				ttsBusy = true;
				console.log('tts started');
				var url = 'http://localhost:1234/begoo/' + text;
				fetch(url)
				.then(data=>{if(data.status === 200)ttsBusy = false; return data;})
				.then(res=>{console.log(res.url)})
				.catch(error=>console.log(error));
			}else{
				postMessage('callTts("' + (arguments.length ? text : '') + '")');
			}
		};

		interpreter.setProperty(globalObject, 'callTts',
			interpreter.createNativeFunction(wrapper));
			
		// Add an API function for the requestServer() block.
		wrapper = function(query){
			postMessage('requestServer("' + (arguments.length ? query : '') + '")');
		}
		interpreter.setProperty(globalObject, 'requestServer',
			interpreter.createNativeFunction(wrapper));

		// Add an API function for the rotate() block.
		wrapper = function(text) {
			return postMessage('rotate("' + (arguments.length ? text : '') + '")');
		};
		interpreter.setProperty(globalObject, 'rotate',
			interpreter.createNativeFunction(wrapper));
	}
</script>
<script type="text/js-worker">
	var code;
	var myInterpreter;
	var intervalRunner;
	var runner = function() {
		if (myInterpreter) {
			do{
				try{
					if(ttsBusy){
						console.log('tts busy');
						return;
					}
					hasMore = myInterpreter.step();
				}catch(error){
					postMessage('error:' + error);
				}finally{
					if (!hasMore){
						// Program is complete.
						clearInterval(intervalRunner);
						myInterpreter = undefined;
						// just in case sth bad happens!!
						ttsBusy = false;
						postMessage('fin');
					}
				}
			}while(hasMore);
		}
	};
	onmessage = function(oEvent) {
		var data = oEvent.data;
		if (data.url) {
			var url = data.url;
			acorn_interpreter_url = url + '/media/acorn_interpreter.js';
			console.log(acorn_interpreter_url);
			importScripts(acorn_interpreter_url);
		}else if(data.code){
			code = data.code;
			// window is not recognized here in this worker context!
			while(code.indexOf('window.') !== -1){
				code = code.replace('window.', '');
			}
			myInterpreter = new Interpreter(code, initApi);
			intervalRunner = setInterval(runner, 100);
		}else{
			console.log(data);
		}
	};
</script>

<script type="text/javascript">
	$('.ui.dropdown').dropdown();
	var workspaceLang = 'fa';
	setLanguageRelatedProps(workspaceLang);
	var myWorkspace = loadWorkspace(workspaceLang);
	myWorkspace.registerButtonCallback("myButtonPressed", callAndroidStt);

	// UI part
	convertCategoriesTosemantic();

	myWorkspace.addChangeListener(function(event) {
      if (!(event instanceof Blockly.Events.Ui)) {
        // Something changed. Parser needs to be reloaded.
        resetInterpreter();
      }
	});
</script>
<script src="block_defs.js"></script>
</body>
</html>